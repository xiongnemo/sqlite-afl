CREATE TABLE t1(a INT);
CREATE TABLE counts(v INTEGER PRIMARY KEY, n INT)/*WITHOUT ROWID*/;
CREATE TRIGGER r1 AFTER INSERT ON t1 BEGIN
  INSERT INTO counts(v,n) VALUES(new.a,1)
      ON CONFLICT(v) DO UPDATE SET n=n+1;
END;
CREATE TRIGGER r2 AFTER UPDATE ON t1 BEGIN
  DELETE FROM counts WHERE v=old.a AND n==1;
  UPDATE counts SET n=n-1 WHERE v=old.a;
  INSERT INTO counts(v,n) VALUES(new.a,1)
      ON CONFLICT(v) DO UPDATE SET n=n+1;
END;
CREATE TRIGGER r3 AFTER DELETE ON t1 BEGIN
  DELETE FROM counts WHERE v=old.a AND n==1;
  UPDATE counts SET n=n-1 WHERE v=old.a;
END;
INSERT INTO t1(a) VALUES(1),(2),(1),(3),(1),(3),(2),(4),(7);
UPDATE t1 SET a=5 WHERE a=4;
DELETE FROM t1 WHERE a=7;
